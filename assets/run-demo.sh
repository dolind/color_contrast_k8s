#!/usr/bin/env bash
set -euo pipefail

APP_NAME=cpu-demo
NAMESPACE=demo-autoscale
IMAGE_TAG=cpu-demo:latest
K8S_FILE=k8s.yaml

echo "üöÄ Starting Kubernetes CPU Autoscaling Demo setup..."

# ------------------------------------------------------
# Build Docker image (backend + prebuilt frontend)
# ------------------------------------------------------
echo "üõ†Ô∏è  Building Docker image..."
docker build -t $IMAGE_TAG .
echo "‚úÖ Image built: $IMAGE_TAG"

# ------------------------------------------------------
# Deploy to Kubernetes
# ------------------------------------------------------
echo "üì§ Deploying to Kubernetes..."
kubectl apply -f $K8S_FILE

echo "‚è≥ Waiting for deployment to become ready..."
kubectl wait --for=condition=available deployment/$APP_NAME -n $NAMESPACE --timeout=120s || true

echo "‚úÖ Deployment ready!"

# ------------------------------------------------------
# Get service information
# ------------------------------------------------------
echo "üîç Getting service info..."
kubectl get svc -n $NAMESPACE

NODE_PORT=$(kubectl get svc $APP_NAME -n $NAMESPACE -o jsonpath='{.spec.ports[0].nodePort}')
HOSTNAME=$(hostname)
URL="https://${HOSTNAME}-${NODE_PORT}.preview.app.killer.sh/"

echo
echo "üåê Open the demo in your browser:"
echo "üëâ  $URL"
echo

# ------------------------------------------------------
# Show HPA status live
# ------------------------------------------------------
echo "üìà Watching Horizontal Pod Autoscaler..."
echo "(Press Ctrl+C to stop)"
kubectl get hpa -n $NAMESPACE -w
